const { Board, Stepper, Servo } = require("johnny-five");
const board = new Board();

const hardware = {
  pen: {
    pin: 11,
  },
};

const instructionSequence = [
  [-24.715112714913673, 0],
  [-291.9750085270414, -579.9994813184597],
  [195.57303801265175, -453.4431150985832],
  [13.520884168296984, -39.86296617400593],
  [-48.91211146534339, -5.5743426735459884],
  [-563.4038183642408, -85.26756374920056],
  [-484.4993305374737, -533.3915016014472],
  [-43.85944476101885, -47.499116466968076],
  [1.857670111957953, 43.85884448147333],
  [-7.368874992118933, 501.1563822568908],
  [-501.1563822568909, 7.36887499211897],
  [-43.85884448147328, -1.8576701119579901],
  [47.499116466968125, 43.859444761018814],
  [533.3915016014472, 484.4993305374738],
  [85.26756374920056, 563.4038183642408],
  [5.5743426735459884, 48.91211146534339],
  [39.86296617400599, -13.520884168297023],
  [453.4431150985831, -195.57303801265172],
  [579.9994813184597, 291.9750085270414],
  [53.759248725397526, 24.715112714913673],
  [-97.60549786862975, -97.60549786862975],
  [-541.2069379175696, -271.9090453546941],
  [-14.207116308455479, -7.288931892130032],
  [-9.840853325737504, 4.820826236688471],
  [-420.7475793305483, 184.3689124385459],
  [-83.16198135040449, -529.1934767883224],
  [-3.1918672773800094, -13.243418079695562],
  [-12.119857231468744, -11.176981603556781],
  [-500.1006961390324, -449.4798485585913],
  [470.26984318907665, -9.58250384429012],
  [10.948371653770737, -0.6742065917030702],
  [0.6742065917030702, -10.948371653770737],
  [9.58250384429012, -470.26984318907665],
  [449.47984855859136, 500.1006961390323],
  [11.176981603556781, 12.119857231468744],
  [13.243418079695562, 3.191867277380009],
  [529.1934767883223, 83.16198135040464],
  [-184.36891243854578, 420.74757933054815],
  [-4.820826236688378, 9.8408533257374],
  [7.288931892129985, 14.20711630845553],
  [271.909045354694, 541.2069379175697],
];

board.on("ready", () => {
  const stepperLeft = new Stepper({
    type: Stepper.TYPE.DRIVER,
    stepsPerRev: 200,
    pins: {
      step: 2,
      dir: 5,
    },
  });
  const stepperRight = new Stepper({
    type: Stepper.TYPE.DRIVER,
    stepsPerRev: 200,
    pins: {
      step: 3,
      dir: 6,
    },
  });

  const pen = new Servo({
    pin: hardware.pen.pin,
    range: [0, 180],
    startAt: 0,
  });
  const liftPen = () => {
    pen.to(0);
  };
  const attachPen = () => {
    pen.to(180);
  };

  const rotate = (motor, degree) =>
    new Promise((resolve, reject) => {
      console.log(`started right ${degree}`);
      motor.step(
        {
          rpm: 180,
          steps: 1600,
          direction: degree > 0 ? 1 : 0,
        },
        () => {
          console.log(`finished left ${degree}`);
          resolve();
        }
      );
    });

  liftPen();

  rotate(stepperRight);
  // instructionSequence.reduce(
  //   (promise, coordinate) =>
  //     promise.then((_) =>
  //       Promise.all([rotateLeft(coordinate[0]), rotateRight(coordinate[1])])
  //     ),
  //   Promise.resolve()
  // );
});
